<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>选课管理系统</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <!-- Bootstrap Switch -->
  <link href="../../plugins/bootstrap-switch/dist/css/bootstrap4/bootstrap-switch.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="../../plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="../../plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="../../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <!-- Google Font: Source Sans Pro -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">
</head>

<body class="hold-transition sidebar-mini">
  <!-- Site wrapper -->
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- Left navbar links -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="index_student.html" class="nav-link">Home</a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="#" class="nav-link">Contact</a>
        </li>
      </ul>

    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="index_student.html" class="brand-link">
        <img src="../../dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
          style="opacity: .8">
        <span class="brand-text font-weight-light">学生端</span>
      </a>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="../../dist/img/avatar04.png" class="img-circle elevation-2" alt="User Image">
          </div>
          <div class="info">
            <a href="#" id="username" class="d-block">Alexander Pierce</a>
          </div>
        </div>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
            <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
            <li class="nav-item">
              <a href="student_info.html" class="nav-link">
                <i class="nav-icon fas fa-address-card"></i>
                <p>个人信息</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="course_timetable.html" class="nav-link">
                <i class="nav-icon far fa-calendar-alt"></i>
                <p>
                  学期课表
                </p>
              </a>
            </li>
            <li class="nav-item has-treeview menu-open">
              <a href="#" class="nav-link active">
                <i class="nav-icon fas fa-th"></i>
                <p>
                  课程管理
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="course_info.html" class="nav-link">
                    <i class="far ion-information-circled nav-icon"></i>
                    <p>课程信息</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="course_select.html" class="nav-link active">
                    <i class="far nav-icon fa-plus-square"></i>
                    <p>添加课程</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="chosen_course.html" class="nav-link">
                    <i class="fas fa-clipboard-list nav-icon"></i>
                    <p>已选课程</p>
                  </a>
                </li>
              </ul>
            </li>
          </ul>

        </nav>
        <!-- /.sidebar-menu -->
        <!-- sidebar log out panel -->
        <div class="nav-item  nav-compact flex-column" role="menu" data-accordion="false">
          <a href="../login.html" class="nav-link">
            <i class="fas nav-icon fa-sign-out-alt fa-2x"
              style="color: rgb(172, 35, 35); position:absolute; bottom:2vmin;left:2vmin;"></i>
            <div style="text-indent:3vmin;font-size: 4vmin; 
          position:absolute;bottom:1%;left:15%;"><b>注销</b></div>
          </a>
        </div>
      </div>
      <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <!-- <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>选课管理</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="index_student.html">Home</a></li>
                <li class="breadcrumb-item active">课程管理</li>
                <li class="breadcrumb-item active">选课管理</li>
              </ol>
            </div>
          </div>
        </div>
      </section> -->

      <!-- Main content -->
      <section class="content">

        <div class="card card-outline card-secondary">
          <div class="card-header">
            <div class="card-tools float-left">
              <button type="button" class="btn btn-tool" data-card-widget="collapse"><i
                  class="fas fa-minus"></i></button>
              <button type="button" class="btn btn-tool" data-card-widget="remove"><i
                  class="fas fa-remove"></i></button>

            </div>
            <button id="search" type="button" class="btn btn-primary btn-sm float-right">
              <i class="ion-search"></i>
              查找
            </button>
          </div>

          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">开课院系</label>
                  <select id="college" class="form-control custom-select-sm" style="width: 100%;">
                    <option value="" selected="select">全部</option>


                    <option value="艺术学院">艺术学院</option>

                    <option value="经济学院">经济学院</option>

                    <option value="法学院">法学院</option>

                    <option value="文学与新闻学院">文学与新闻学院</option>

                    <option value="外国语学院">外国语学院</option>

                    <option value="历史文化学院（旅游学院）">历史文化学院（旅游学院）</option>

                    <option value="马克思主义学院">马克思主义学院</option>

                    <option value="国际关系学院">国际关系学院</option>

                    <option value="数学学院">数学学院</option>

                    <option value="物理学院">物理学院</option>

                    <option value="化学学院">化学学院</option>

                    <option value="生命科学学院">生命科学学院</option>

                    <option value="电子信息学院">电子信息学院</option>

                    <option value="高分子科学与工程学院">高分子科学与工程学院</option>

                    <option value="材料科学与工程学院">材料科学与工程学院</option>

                    <option value="机械工程学院">机械工程学院</option>

                    <option value="电气工程学院">电气工程学院</option>

                    <option value="计算机学院">计算机学院</option>

                    <option value="建筑与环境学院">建筑与环境学院</option>

                    <option value="水利水电学院">水利水电学院</option>

                    <option value="化学工程学院">化学工程学院</option>

                    <option value="轻工科学与工程学院">轻工科学与工程学院</option>

                    <option value="软件学院">软件学院</option>

                    <option value="四川大学匹兹堡学院">四川大学匹兹堡学院</option>

                    <option value="空天科学与工程学院">空天科学与工程学院</option>

                    <option value="网络空间安全学院">网络空间安全学院</option>

                    <option value="公共管理学院">公共管理学院</option>

                    <option value="商学院">商学院</option>

                    <option value="灾后重建与管理学院">灾后重建与管理学院</option>

                    <option value="华西基础医学与法医学院">华西基础医学与法医学院</option>

                    <option value="华西临床医学院">华西临床医学院</option>

                    <option value="华西口腔医学院">华西口腔医学院</option>

                    <option value="华西公共卫生学院">华西公共卫生学院</option>

                    <option value="华西药学院">华西药学院</option>


                    <option value="吴玉章学院">吴玉章学院</option>

                    <option value="体育学院">体育学院</option>


                    <option value="网络教育学院">网络教育学院</option>

                    <option value="图书馆">图书馆</option>



                  </select>
                </div>
                <!-- /.form-group -->

                <!-- /.form-group -->
              </div>
              <!-- /.col -->
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">校区</label>
                  <select id="campus" class="form-control custom-select-sm" style="width: 100%;">
                    <option value="" selected="selected">全部</option>
                    <option value="江安">江安</option>
                    <option value="华西">华西</option>
                    <option value="望江">望江</option>
                  </select>
                </div>

              </div>
              <!-- /.form-group -->
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">上课节次</label>
                  <select id='section' class="form-control custom-select-sm" style="width: 100%;">
                    <option value="">全部</option>

                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">课程号</label>
                  <input id='course_id' type="text" name="course_id" class="form-control form-control-sm" />
                </div>

              </div>
            </div>

            <div class="row">
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">课程属性</label>
                  <select id="attribute" class="form-control custom-select-sm" style="width: 100%;">
                    <option value="" selected="select">全部</option>
                    <option value="必修">必修</option>
                    <option value="选修">选修</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">上课星期</label>
                  <select id="weekday" class="form-control custom-select-sm" style="width: 100%;">
                    <option value="">全部</option>

                    <option value="1">星期一</option>
                    <option value="2">星期二</option>
                    <option value="3">星期三</option>
                    <option value="4">星期四</option>
                    <option value="5">星期五</option>
                    <option value="6">星期六</option>
                    <option value="7">星期日</option>
                  </select>
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">教师名</label>
                  <input id="teacher_name" type="text" name="teacher_name" class="form-control form-control-sm" />
                </div>
              </div>
              <div class="col-md-3">
                <div class="form-group">
                  <label class="col-form-label col-form-label-sm">课程名</label>
                  <input id="course_name" type="text" name="course_name" class="form-control form-control-sm" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Default box -->

        <div class="card card-outline card-secondary">
          <div class="card-header">
            <h3 class="card-title">列表</h3>
            <button id="submit" type="button" class="btn btn-info btn-sm float-right">
              <i class="fas fa-save"></i>
              提交
            </button>
          </div>
          <!-- /.card-header -->
          <div class="card-body">
            <div class="col-auto">
              <table id="example2" class="table table-responsive table-bordered table-hover">
                <thead>
                  <tr>
                    <th class="text-sm">课程名</th>
                    <th class="text-sm">课程号</th>
                    <th class="text-sm">课序号</th>
                    <th class="text-sm">学分</th>
                    <th class="text-sm">课程属性</th>
                    <th class="text-sm">教师</th>
                    <th class="text-sm">周次</th>
                    <th class="text-sm">星期</th>
                    <th class="text-sm">节次</th>
                    <th class="text-sm">校区</th>
                    <th class="text-sm">教学楼</th>
                    <th class="text-sm">教室</th>
                    <th class="text-sm">课余量</th>
                    <th class="text-sm">添加课程</th>
                  </tr>
                </thead>
                <tbody id="example2_body">
                  <tr>
                    <td>计算机系统结构</td>
                    <td>60530412</td>
                    <td>01</td>
                    <td>3</td>
                    <td>选修</td>
                    <td>倪云竹</td>
                    <td>1-17周</td>
                    <td>星期三</td>
                    <td>5-7节</td>
                    <td>江安</td>
                    <td>一教A座</td>
                    <td>A513</td>
                    <td>65</td>
                    <td>
                      <input type="checkbox" name="my-checkbox">
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->

      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Select2 -->
  <script src="../../plugins/select2/js/select2.full.min.js"></script>
  <!-- DataTables -->
  <script src="../../plugins/datatables/jquery.dataTables.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.js"></script>
  <!-- Bootstrap Switch -->
  <script src="../../plugins/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="../../plugins/sweetalert2/sweetalert2.min.js"></script>
  <!-- InputMask
  <script src="../../plugins/moment/moment.min.js"></script>
  <script src="../../plugins/inputmask/min/jquery.inputmask.bundle.min.js"></script> -->
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="../../dist/js/demo.js"></script>
  <!-- page script -->
  <script>
    $(function () {
      $("#example1").DataTable();
      $('#example2').DataTable({
        "paging": true,
        "lengthChange": false,
        "searching": false,
        "ordering": true,
        "info": true,
        "autoWidth": false,
      });
    });

    $("input[data-bootstrap-switch]").each(function () {
      $(this).bootstrapSwitch('state', !$(this).prop('checked'));
      //没有unchecked属性，由prop返回为true or false来确定按钮状态
    });

    // $("[name='my-checkbox']").bootstrapSwitch();
  </script>
  <!-- coder custom render -->
  <script>

    $(function () {
      var user = JSON.parse(sessionStorage.getItem("user"));
      $("#username").text(user.name);

      //preload
      search();

      $("#search").click(search);
      $("#submit").click(submit);
    });

    var jsonStr = [];
    $('#example2_body').on('each click', 'input', function () {
      var course_id = $(this).parent().parent().children().eq(1).text();
      var course_seq = $(this).parent().parent().children().eq(2).text();
      var temp = {
        'course_id': course_id,
        'course_seq': course_seq
      };
      console.log(temp);

      if ($(this).prop('checked') === true) {
        jsonStr.push(temp);
      }
      else {
        var index = jsonStr.findIndex(function (ob) {
          return ob.course_id === temp.course_id &&
            ob.course_seq === temp.course_seq;
        });
        jsonStr.splice(index, 1);
      }
    })

    //submit respnse message
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3000
    });

    function submit() {
      // var jsonStr = [{
      //   'course_id': "101260030",
      //   'course_seq': "1"
      // }];
      //for bootstrap-switch checkbox
      // $('#example2_body').on('click', 'input[data-bootstrap-switch]', function () {
      //   if ($(this).prop("checked") == true) {
      //     var course_id = $(this).parent().parent().parent().parent().children().eq(1).text();
      //     var course_seq = $(this).parent().parent().parent().parent().children().eq(2).text();
      //     var temp = {
      //       'course_id': "101260030",
      //       'course_seq': "1"
      //     }
      //     jsonStr.push(temp);
      //   }
      // })

      //for ordinary checkbox

      console.log(JSON.stringify(jsonStr));
      var user = JSON.parse(sessionStorage.getItem('user'));
      $.post("http://localhost:8080/dbLab_war_exploded/select",
        {
          "fromdata": JSON.stringify(jsonStr),
          "id": user.id
        },
        function (res) {
          /*
          [
            {
              course_id:   ,
              course_seq:  ,
              info:1 stands for success ,0 stands for fail,
              message;
            },
            {
              ...
            }
          ]
          */
          //已选课程的disable问题
          var data = JSON.parse(res);
          var state = true;
          for (i in data) {
            //choose course successfully
            if (data[i].info === '1') {
              //find corelated course
              var temp = $('#example2_body').children();
              temp.each(function () {
                if ($(this).children().eq(1).text() === data[i].course_id &&
                  $(this).children().eq(2).text() === data[i].course_seq) {
                  $(this).children().eq(13).hide();
                }
              });

            } else {
              if (data[i].message === '') {
                //complete error
                Toast.fire({
                  type: 'error',
                  title:'选课失败！'
                })
              }else{
                //explainable error
                Toast.fire({
                  type:'warning',
                  title:'课程'+data[i].course_id+' '+data[i].course_seq+' '+data[i].message
                })
              }
              state=false;
            }
          };
          //success message
          if (state) {
            Toast.fire({
              type: 'success',
              title: '选课成功！'
            });
          }
        })
    }

    function search() {
      //clear preload data
      $("#example2_body").empty();
      var course_id = $("#course_id").val();
      var course_name = $("#course_name").val();
      var teacher_name = $("#teacher_name").val();
      var college = $("#college").val();
      var campus = $("#campus").val();
      var section = $("#section").val();
      var attribute = $("#attribute").val();
      var weekday = $("#weekday").val();
      var user = JSON.parse(sessionStorage.getItem('user'));
      var json = {
        'id': user.id,
        'course_id': course_id,
        'course_name': course_name,
        'teacher_name': teacher_name,
        'college': college,
        'campus': campus,
        'section': section,
        'attribute': attribute,
        'weekday': weekday,
      }

      $.post("http://localhost:8080/dbLab_war_exploded/search", { "fromdata": JSON.stringify(json) },
        function (data) {
          data = JSON.parse(data);
          // data -> server returned json 
          // [
          //     {
          //         "course_id":"",
          //         "course_seq":"",
          //         "course_name":"",
          //         "teacher_name":"",
          //         "credit":"",
          //         "attribute":"",
          //         "duration":"",
          //         "weekday":"",
          //         "section":"",
          //         "campus":"",
          //         "building":"",
          //         "classroom":"",
          //         "capacity":"",
          //         "selected":0 or 1
          //     },//one class record
          //     {
          //         ...
          //     }
          // ]
          var str = "";
          for (i in data) {
            str += "<tr>" +
              "<td>" + data[i].course_name + "</td>" +
              "<td>" + data[i].course_id + "</td>" +
              "<td>" + data[i].course_seq + "</td>" +
              "<td>" + data[i].credit + "</td>" +
              "<td>" + data[i].attribute + "</td>" +
              "<td>" + data[i].teacher_name + "</td>" +
              "<td>" + data[i].duration + "</td>" +
              "<td>" + data[i].weekday + "</td>" +
              "<td>" + data[i].section + "</td>" +
              "<td>" + data[i].campus + "</td>" +
              "<td>" + data[i].building + "</td>" +
              "<td>" + data[i].classroom + "</td>" +
              "<td>" + data[i].capacity + "</td>" +
              "<td>" +
              `<input type="checkbox" name="my-checkbox" ${data[i].selected==='1' ? 'disabled' : ''}>` +
              "</td>" +
              "</tr>"
          };
          $("#example2_body").append(str);
        })
    }
    //暂不支持使用bootstrap-switch选课
  </script>
</body>

</html>